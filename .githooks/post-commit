#!/bin/bash
# Janus Forge Cycle Post-commit Hook
# Detects Forge Cycle completion and triggers version bumps

set -e

echo "üîß Janus Forge Cycle: Post-commit analysis..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[1;34m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    local color=$1
    local message=$2
    echo -e "${color}${message}${NC}"
}

# Check if this commit contains Forge Cycle artifacts
COMMIT_HASH=$(git rev-parse HEAD)
BRANCH=$(git branch --show-current)

print_status $BLUE "üîç Analyzing commit $COMMIT_HASH on branch $BRANCH"

# Check for VERSION file changes
if git diff --name-only HEAD~1..HEAD | grep -q "^VERSION$"; then
    print_status $GREEN "‚úÖ VERSION file updated in this commit"
    NEW_VERSION=$(cat VERSION)
    print_status $GREEN "üìà New version: $NEW_VERSION"
else
    print_status $YELLOW "‚ÑπÔ∏è  No VERSION changes in this commit"
fi

# Check for spec files (Architect completion)
SPEC_FILES=$(git diff --name-only HEAD~1..HEAD | grep "^\.codex/specs/.*\.md$" | wc -l)

if [ "$SPEC_FILES" -gt 0 ]; then
    print_status $GREEN "üèóÔ∏è  Forge Cycle artifacts detected ($SPEC_FILES spec files)"

    # Check if this looks like a new feature spec (Architect completion)
    NEW_SPEC_FILES=$(git diff --name-only HEAD~1..HEAD | grep "^\.codex/specs/spec-.*\.md$" | wc -l)

    if [ "$NEW_SPEC_FILES" -gt 0 ]; then
        print_status $YELLOW "üèóÔ∏è  New or modified spec files detected"
        echo "üí° Consider running: ./janus version bump feature"
        echo "   (if this represents a feature completion)"
    fi

    # Check for feature directories with new specs
    FEATURE_SPECS=$(git diff --name-only HEAD~1..HEAD | grep "^\.codex/specs/.*/spec\.md$" | wc -l)

    if [ "$FEATURE_SPECS" -gt 0 ]; then
        print_status $YELLOW "üìã Feature specifications updated"
        echo "üí° This may warrant a minor version bump"
    fi
else
    print_status $YELLOW "‚ÑπÔ∏è  No spec file changes detected"
fi

# Check for implementation files (Implementer completion)
SRC_FILES=$(git diff --name-only HEAD~1..HEAD | grep "^src/.*\.zig$" | wc -l)
TEST_FILES=$(git diff --name-only HEAD~1..HEAD | grep -E "^tests?/.*\.zig$" | wc -l)

if [ "$SRC_FILES" -gt 0 ] || [ "$TEST_FILES" -gt 0 ]; then
    print_status $GREEN "‚ö° Implementation changes detected"
    print_status $BLUE "   Source files: $SRC_FILES"
    print_status $BLUE "   Test files: $TEST_FILES"

    if [ "$SRC_FILES" -gt 0 ]; then
        print_status $YELLOW "üí° Consider running: ./janus version bump task"
        echo "   (if this represents a task completion)"
    fi
fi

# Branch-specific suggestions
if [[ "$BRANCH" == "main" ]] || [[ "$BRANCH" == release* ]]; then
    print_status $BLUE "üèõÔ∏è  On stable branch ($BRANCH)"

    if [[ "$NEW_VERSION" == *"-dev"* ]]; then
        print_status $YELLOW "‚ö†Ô∏è  Dev version on stable branch"
        echo "üí° Consider running: ./janus version bump release"
        echo "   (to convert to clean release version)"
    else
        print_status $GREEN "‚úÖ Clean version format for stable branch"
    fi
else
    print_status $BLUE "üöß On development branch ($BRANCH)"

    if [[ ! "$NEW_VERSION" == *"-dev"* ]]; then
        print_status $YELLOW "‚ö†Ô∏è  Missing -dev suffix on dev branch"
        echo "üí° Consider running: ./janus version bump dev"
    fi

    if [[ ! "$NEW_VERSION" == *"+"* ]]; then
        print_status $YELLOW "‚ö†Ô∏è  Missing Git hash metadata"
        echo "üí° Consider running: ./janus version bump dev"
    fi
fi

# Check for breaking changes (would need semantic analysis of commit messages)
COMMIT_MSG=$(git log -1 --pretty=%B)
if echo "$COMMIT_MSG" | grep -qi "breaking\|break\|major"; then
    print_status $RED "üí• Breaking changes detected in commit message"
    echo "üí° This may warrant a major version bump"
    echo "   Consider running: ./janus version bump major"
fi

print_status $GREEN "‚ú® Post-commit analysis complete!"
echo ""
echo "üîß Next Steps:"
echo "  - Run './janus version bump <type>' to update version based on changes"
echo "  - Use './janus version show' to check current version"
echo "  - Use './janus version bump release' when ready for stable release"
echo ""

# Optional: Auto-suggest version bump based on heuristics
AUTO_BUMP=false

# If we have new spec files and no version bump, suggest feature bump
if [ "$SPEC_FILES" -gt 0 ] && ! git diff --name-only HEAD~1..HEAD | grep -q "^VERSION$"; then
    print_status $YELLOW "ü§ñ Auto-suggestion: Consider './janus version bump feature'"
    AUTO_BUMP=true
fi

# If we have implementation changes but no version bump, suggest task bump
if { [ "$SRC_FILES" -gt 0 ] || [ "$TEST_FILES" -gt 0 ]; } && ! git diff --name-only HEAD~1..HEAD | grep -q "^VERSION$"; then
    print_status $YELLOW "ü§ñ Auto-suggestion: Consider './janus version bump task'"
    AUTO_BUMP=true
fi

if [ "$AUTO_BUMP" = true ]; then
    echo ""
    print_status $BLUE "üí° Quick commands:"
    echo "  ./janus version bump feature    # For new features"
    echo "  ./janus version bump task       # For implementation tasks"
    echo "  ./janus version bump dev        # For development builds"
    echo "  ./janus version bump release    # For stable releases"
fi

exit 0