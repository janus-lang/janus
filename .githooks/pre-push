#!/bin/bash
# Janus Pre-Push Hook - Final Quality Gate
# Comprehensive validation before code reaches remote repository

set -e

echo "ğŸš€ Janus Pre-Push Quality Gate"
echo "=============================="

# AI-Airlock Protocol Enforcement
PROTECTED_BRANCHES="^(stable|dev|main)$"
AI_EMAIL="voxis-forge@janus-lang.org"
AI_NAME="Voxis Forge AI"
CURRENT_EMAIL=$(git config user.email)
CURRENT_NAME=$(git config user.name)

# Check if we're the AI agent
IS_AI=false
if [[ "$CURRENT_EMAIL" == "$AI_EMAIL" ]] || [[ "$CURRENT_NAME" == "$AI_NAME" ]]; then
    IS_AI=true
fi

# Get information about what's being pushed
while read local_ref local_sha remote_ref remote_sha; do
    # Extract branch name from remote_ref
    if [[ "$remote_ref" =~ refs/heads/(.+)$ ]]; then
        BRANCH="${BASH_REMATCH[1]}"
    else
        BRANCH="unknown"
    fi

    # AI-AIRLOCK CHECK: Block AI from protected branches
    if echo "$BRANCH" | grep -qE "$PROTECTED_BRANCHES"; then
        if [[ "$IS_AI" == true ]]; then
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘         AI-AIRLOCK: ACCESS DENIED                          â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "âŒ AI agents cannot push directly to protected branch: $BRANCH"
            echo ""
            echo "The Airlock Protocol requires:"
            echo "  1. Create a feature branch: git checkout -b features/ai/your-feature"
            echo "  2. Push your changes there:  git push origin features/ai/your-feature"
            echo "  3. Open a Pull Request to '$BRANCH'"
            echo "  4. Wait for Human Review and Merge"
            echo ""
            echo "This is a MECHANISM, not a policy. It enforces Human-in-the-Loop."
            echo ""
            echo "ğŸ“– See: docs/doctrines/AIRLOCK.md"
            echo ""
            exit 1
        else
            echo "âœ… Human identity: $CURRENT_NAME <$CURRENT_EMAIL>"
            echo "âš ï¸  Pushing to protected branch: $BRANCH"
        fi
    fi

    if [ "$local_sha" = "0000000000000000000000000000000000000000" ]; then
        # Branch is being deleted
        continue
    fi

    if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
        # New branch
        range="$local_sha"
    else
        # Update to existing branch
        range="$remote_sha..$local_sha"
    fi

    echo "ğŸ” Validating commits: $range"

    # 1. Comprehensive Build Test
    echo "ğŸ”¨ Full build validation..."
    if ! zig build -Doptimize=ReleaseFast; then
        echo "âŒ Release build failed"
        exit 1
    fi
    echo "âœ… Release build OK"

    # 2. Complete Test Suite
    echo "ğŸ§ª Complete test suite..."
    if ! zig build test; then
        echo "âŒ Test suite failed"
        exit 1
    fi
    echo "âœ… Test suite OK"

    # 3. Cross-Platform Build Check
    echo "ğŸŒ Cross-platform build check..."

    # Test key cross-compilation targets
    TARGETS=(
        "x86_64-linux-musl"
        "aarch64-linux-gnu"
        "x86_64-windows-gnu"
    )

    for target in "${TARGETS[@]}"; do
        echo "  ğŸ”¨ Testing $target..."
        if ! zig build -Dtarget=$target -Doptimize=ReleaseFast 2>/dev/null; then
            echo "  âš ï¸ Cross-compilation failed for $target (may be expected)"
        else
            echo "  âœ… $target OK"
        fi
    done

    # 4. Commit Quality Check
    echo "ğŸ“ Commit quality validation..."

    # Check for merge commits (discouraged in main branch)
    if [ "$remote_ref" = "refs/heads/main" ]; then
        MERGE_COMMITS=$(git rev-list --merges $range 2>/dev/null | wc -l)
        if [ "$MERGE_COMMITS" -gt 0 ]; then
            echo "âš ï¸ Found $MERGE_COMMITS merge commits in main branch"
            echo "   Consider using rebase workflow for cleaner history"
        fi
    fi

    # Check commit message quality
    git rev-list $range | while read commit; do
        MSG=$(git log --format=%s -n 1 $commit)
        if [ ${#MSG} -gt 72 ]; then
            echo "âš ï¸ Long commit subject: $MSG"
            echo "   Consider keeping subjects under 72 characters"
        fi
    done

    # 5. Security Check
    echo "ğŸ”’ Security validation..."

    # Check for potential secrets
    if git diff --name-only $range | xargs grep -l "password\|secret\|key\|token" 2>/dev/null; then
        echo "âš ï¸ Potential secrets found in commit"
        echo "   Review carefully before pushing"
    fi

    # Check for debug code
    DEBUG_PATTERNS="console\.log\|std\.debug\.print.*TODO\|FIXME.*HACK"
    if git diff $range | grep -E "$DEBUG_PATTERNS" >/dev/null 2>&1; then
        echo "âš ï¸ Debug code or TODO items found in diff"
        echo "   Consider cleaning up before push"
    fi

    # 6. Critical Quality Checks (only for main/unstable branches)
    CURRENT_BRANCH=$(git branch --show-current)
    if [[ "$remote_ref" == "refs/heads/main" || "$remote_ref" == "refs/heads/unstable" ]]; then
        echo "ğŸ” Critical quality checks for $CURRENT_BRANCH..."

        # License compliance check - only check changed files, not all files
        if [[ -x "scripts/validate-license-headers.sh" ]]; then
            echo "  ğŸ“œ License header validation..."
            # Get changed script/shell files only
            CHANGED_SCRIPTS=$(git diff --name-only $range | grep -E '\.(sh|bash)$' || true)
            if [[ -n "$CHANGED_SCRIPTS" ]]; then
                echo "$CHANGED_SCRIPTS" | xargs -I {} scripts/validate-license-headers.sh "{}" >/dev/null 2>&1
                echo "  âœ… License headers OK"
            else
                echo "  âœ… No script changes to validate"
            fi
        fi

        # Version consistency check
        if [[ -x "scripts/check-version.sh" ]]; then
            echo "  ğŸ·ï¸  Version consistency check..."
            scripts/check-version.sh >/dev/null 2>&1
            echo "  âœ… Version OK"
        fi

        # Profile compatibility check
        if [[ -x "scripts/check-profiles.sh" ]]; then
            echo "  ğŸ­ Profile compatibility check..."
            scripts/check-profiles.sh >/dev/null 2>&1
            echo "  âœ… Profiles OK"
        fi

        # Build verification
        if [[ -x "scripts/check-build.sh" ]]; then
            echo "  ğŸ”¨ Build verification..."
            scripts/check-build.sh >/dev/null 2>&1
            echo "  âœ… Build OK"
        fi
    fi

    echo "âœ… Commit range validated: $range"
done

echo ""
echo "ğŸ‰ All pre-push checks passed!"
echo "ğŸš€ Code is ready for remote repository"
echo ""