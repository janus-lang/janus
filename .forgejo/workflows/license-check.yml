# SPDX-License-Identifier: LSL-1.0
# Copyright (c) 2025 Markus Maiwald

name: License Header Check

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]

jobs:
  license-check:
    name: Check License Headers
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        # Fetch full history for accurate file analysis
        fetch-depth: 0

    - name: Set up environment
      run: |
        echo "REPO_ROOT=$GITHUB_WORKSPACE" >> $GITHUB_ENV

    - name: Make license check script executable
      run: chmod +x scripts/pre-commit-license-check.sh

    - name: Check license headers in changed files
      id: license-check
      run: |
        # For pull requests, check only changed files
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "Checking files changed in PR..."

          # Get list of changed files (Forgejo/Gitea compatible)
          git fetch origin ${{ github.base_ref }}
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_re

          if [ -z "$CHANGED_FILES" ]; then
            echo "No files changed in this PR"
            exit 0
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"
          echo ""

          # Create temporary script to check only changed files
          cat > check_changed_files.sh << 'EOF'
          #!/bin/bash
          set -euo pipefail

          # Source the main license check functions
          source scripts/pre-commit-license-check.sh

          # Override the main function to check specific files
          check_specific_files() {
            local exit_code=0
            local files_checked=0
            local files_failed=0

            echo "ðŸ” Checking license headers in changed files..."

            while IFS= read -r file; do
              [[ -z "$file" ]] && continue
              [[ ! -f "$file" ]] && continue

              if needs_license_header "$file"; then
                files_checked=$((files_checked + 1))
                expected_license=$(get_expected_license "$file")

                if ! check_license_header "$file" "$expected_license"; then
                  files_failed=$((files_failed + 1))
                  exit_code=1
                  echo "âŒ License header violation: $file"
                  show_expected_header "$file" "$expected_license"
                  echo ""
                fi
              fi
            done

            # Summary
            if [[ $exit_code -eq 0 ]]; then
              echo "âœ… All $files_checked changed files have correct license headers"
            else
              echo "âŒ $files_failed of $files_checked changed files have license header violations"
              echo "ðŸ’¡ Add the required license headers and push again"
              echo "ðŸ“– Complete guide: docs/LICENSE-HEADERS.md"
            fi

            return $exit_code
          }

          # Check the changed files
          echo "$CHANGED_FILES" | check_specific_files
          EOF

          chmod +x check_changed_files.sh
          ./check_changed_files.sh

        else
          # For pushes to main/develop, run full check
          echo "Running full license header check..."
          ./scripts/pre-commit-license-check.sh
        fi

    - name: Generate license compliance report
      if: always()
      run: |
        echo "# License Compliance Report" > license-report.md
        echo "" >> license-report.md
        echo "**Workflow**: ${{ github.workflow }}" >> license-report.md
        echo "**Event**: ${{ github.event_name }}" >> license-report.md
        echo "**Branch**: ${{ github.ref_name }}" >> license-report.md
        echo "**Commit**: ${{ github.sha }}" >> license-report.md
        echo "**Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> license-report.md
        echo "**Platform**: Forgejo/Gitea" >> license-report.md
        echo "" >> license-report.md

        if [ "${{ steps.license-check.outcome }}" = "success" ]; then
          echo "**Status**: âœ… PASSED" >> license-report.md
          echo "" >> license-report.md
          echo "All source files have correct license headers." >> license-report.md
        else
          echo "**Status**: âŒ FAILED" >> license-report.md
          echo "" >> license-report.md
          echo "Some files are missing or have incorrect license headers." >> license-report.md
          echo "See the job logs above for details." >> license-report.md
        fi

        echo "" >> license-report.md
        echo "## License Requirements" >> license-report.md
        echo "" >> license-report.md
        echo "- **Compiler/Tooling**: LSL-1.0" >> license-report.md
        echo "- **Standard Library**: Apache-2.0" >> license-report.md
        echo "- **Community Packages**: CC0-1.0" >> license-report.md
        echo "" >> license-report.md
        echo "See [docs/LICENSE-HEADERS.md](docs/LICENSE-HEADERS.md) for complete guide." >> license-report.md

    - name: Upload compliance report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: license-compliance-report-forgejo
        path: license-report.md
        retention-days: 30

    # Note: Forgejo/Gitea may not support automatic PR commenting
    # This would need to be implemented using the Forgejo/Gitea API
    - name: Save PR comment for manual review
      if: failure() && github.event_name == 'pull_request'
      run: |
        cat > pr-comment.md << 'EOF'
        ## âŒ License Header Check Failed

        Some files in this PR are missing required license headers.

        **How to fix:**
        1. Add the appropriate license header to each file (see the job logs for specific files)
        2. Use the correct SPDX identifier based on the file's directory
        3. Push your changes to update this PR

        **Need help?** See [docs/LICENSE-HEADERS.md](docs/LICENSE-HEADERS.md) for templates and examples.

        **Automated tools available:**
        ```bash
        # Check which files need headers
        ./scripts/pre-commit-license-check.sh

        # Add headers automatically
        ./scripts/add-license-headers.sh --dry-run  # Preview
        ./scripts/add-license-headers.sh            # Apply
        ```
        EOF

        echo "PR comment saved to pr-comment.md for manual posting if needed"

  license-audit:
    name: License Audit
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Make scripts executable
      run: |
        chmod +x scripts/pre-commit-license-check.sh
        chmod +x scripts/license-compliance-scan.sh

    - name: Run comprehensive license audit
      run: |
        echo "# Comprehensive License Audit (Forgejo/Gitea)" > audit-report.md
        echo "" >> audit-report.md
        echo "**Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> audit-report.md
        echo "**Commit**: ${{ github.sha }}" >> audit-report.md
        echo "**Platform**: Forgejo/Gitea" >> audit-report.md
        echo "" >> audit-report.md

        # Count files by license type
        echo "## File Count by License" >> audit-report.md
        echo "" >> audit-report.md

        eupl_count=$(find . -name "*.zig" -o -name "*.ts" -o -name "*.js" -o -name "*.py" -o -name "*.sh" -o -name "*.c" -o -name "*.h" | grep -E "(src/|compiler/|daemon/|lsp/|tools/|tests/|scripts/|packaging/|vscode-extension/)" | wc -l || echo "0")
        apache_count=$(find std/ -name "*.jan" 2>/dev/null | wc -l || echo "0")
        cc0_count=$(find packages/ examples/ -name "*.jan" -o -name "*.zig" 2>/dev/null | wc -l || echo "0")

        echo "- **LSL-1.0 (Compiler/Tooling)**: $eupl_count files" >> audit-report.md
        echo "- **Apache-2.0 (Standard Library)**: $apache_count files" >> audit-report.md
        echo "- **CC0-1.0 (Packages/Examples)**: $cc0_count files" >> audit-report.md
        echo "" >> audit-report.md

        # Check for files without headers
        echo "## Files Missing Headers" >> audit-report.md
        echo "" >> audit-report.md

        missing_files=$(./scripts/pre-commit-license-check.sh 2>&1 | grep "âŒ" | wc -l || echo "0")

        if [ "$missing_files" -eq 0 ]; then
          echo "âœ… All source files have correct license headers" >> audit-report.md
        else
          echo "âš ï¸ Found $missing_files files with missing or incorrect headers" >> audit-report.md
          echo "" >> audit-report.md
          echo "Run \`./scripts/pre-commit-license-check.sh\` for details." >> audit-report.md
        fi

        # Run full compliance scan if available
        if [ -x "./scripts/license-compliance-scan.sh" ]; then
          echo "" >> audit-report.md
          echo "## Detailed Compliance Report" >> audit-report.md
          echo "" >> audit-report.md
          ./scripts/license-compliance-scan.sh --format markdown >> audit-report.md
        fi

        echo "" >> audit-report.md
        echo "## License Distribution" >> audit-report.md
        echo "" >> audit-report.md
        echo "The Janus project uses a tiered licensing model:" >> audit-report.md
        echo "" >> audit-report.md
        echo "- **Core compiler and tooling** (LSL-1.0): Strong copyleft protection" >> audit-report.md
        echo "- **Standard library** (Apache-2.0): Permissive for maximum adoption" >> audit-report.md
        echo "- **Community packages** (CC0-1.0): Public domain for maximum reusability" >> audit-report.md

    - name: Upload audit report
      uses: actions/upload-artifact@v4
      with:
        name: license-audit-report-forgejo
        path: audit-report.md
        retention-days: 90